<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Hunt: Showdown - Outfitter</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet" />
    <link href="/vendor/materialdesignicons.5x/materialdesignicons.5.x.min.css" rel="stylesheet" />
    <link href="/vendor/vuetify.2.5.8.min.css" rel="stylesheet" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui"
    />
  </head>
  <body>
    <div
      id="app"
      v-cloak
    >
      <v-app>
        <v-main class="ma-5">
          <v-container
            fluid
            class="fill-height"
          >
            <!-- Header -->
            <v-row
              justify="center"
              align="center"
              class="pb-2"
            >
              <div>
                <h1>Hunt: Showdown Outfitter</h1>
                <div class="info--text caption">
                  Please use <b>Window Mode: Fullscreen</b> for best
                  results and equip from the <b>Roster > Overview</b>
                  screen only.
                </div>
              </div>
              <v-spacer></v-spacer>
              <div class="d-flex flex-column align-end">
                <div
                  v-if="currentFilepath"
                  class="caption grey--text mb-1"
                >
                  <v-btn
                    icon
                    x-small
                    title="Reset current filepath"
                    @click="resetCurrentFilepath()"
                  >
                    <v-icon color="error lighten-4">mdi-close</v-icon>
                  </v-btn>
                  {{ currentFilepath }}
                </div>
                <div class="d-flex flex-wrap">
                  <v-btn
                    icon
                    large
                    class="mr-2"
                    :class="editing.settings ? 'primary' : null"
                    title="Settings"
                    @click="toggleSettings()"
                  >
                    <v-icon :color="editing.settings ? 'white' : null">mdi-cog</v-icon>
                  </v-btn>
                  <v-btn
                    v-if="currentFilepath"
                    icon
                    class="mr-2"
                    large
                    :title="'Save to current file: ' + currentFilepath"
                    @click="saveToCurrentFile()"
                  >
                    <v-icon>mdi-content-save</v-icon>
                  </v-btn>
                  <v-btn
                    icon
                    class="mr-2"
                    large
                    title="Save as new File"
                    @click="exportToFile()"
                  >
                    <v-icon>mdi-file-export-outline</v-icon>
                  </v-btn>
                  <v-btn
                    icon
                    class="mr-2"
                    large
                    title="Open File"
                    @click="importFromFile()"
                  >
                    <v-icon>mdi-file-import-outline</v-icon>
                  </v-btn>
                  <v-btn
                    icon
                    title="Check GitHub for updates: https://github.com/cb109/hunt_showdown_outfitter"
                    large
                    @click="openGitHubPageInDefaultBrowser()"
                  >
                    <v-icon>mdi-github</v-icon>
                  </v-btn>
                </div>
              </div>
            </v-row>
            <!-- Loading indicator -->
            <div
              v-if="loading"
              class="d-flex justify-center fill-height"
              style="width: 100%; margin-top: 100px;"
            >
              <v-progress-circular
                indeterminate
                color="primary"
                size="72"
                width="5"
              ></v-progress-circular>
            </div>
            <!-- Settings Overlay Page -->
            <v-row
              v-if="!loading && editing.settings"
              class="fill-height"
            >
              <v-col>
                <h2 class="mt-3">Settings</h2>
                <p>
                  In order to automate the inventory we need to know
                  where the item slots and some buttons are (X and Y
                  coordinates in pixels, depending on your <b>screen
                  resolution</b>).
                </p>
                <div class="d-flex align-center">
                  <div>
                    <h3 class="title">UI Element Coordinates</h3>
                    <p>You can tweak each coordinate pair here.</p>
                  </div>
                  <v-btn
                    outlined
                    rounded
                    color="secondary"
                    class="ml-4"
                    @click="estimate.dialog = true"
                  >
                    <v-icon left>mdi-ruler</v-icon>
                    Estimate coordinates
                  </v-btn>
                  <!-- Estimate Coordinates Dialog -->
                  <v-dialog
                    v-model="estimate.dialog"
                    width="400"
                    persistent
                  >
                    <v-card>
                      <v-card-title>Estimate UI Element Coordinates</v-card-title>
                      <v-card-text>
                        <p>
                          Based on internal samples we try to guess
                          the coordinates for your specific
                          resolution.
                        </p>
                        <div class="d-flex align-center">
                          <v-text-field
                            v-model="estimate.width"
                            type="number"
                            class="number-input mr-4"
                            label="Screen Width"
                            suffix="px"
                            hide-details
                          ></v-text-field>
                          <v-text-field
                            v-model="estimate.height"
                            type="number"
                            class="number-input"
                            label="Screen Height"
                            suffix="px"
                            hide-details
                          ></v-text-field>
                        </div>
                      </v-card-text>
                      <v-card-actions class="flex-column">
                        <div class="caption warning--text mb-3">
                          The estimated coordinates will overwrite your current values.
                        </div>
                        <div class="d-flex" style="width: 100%">
                          <v-btn
                            text
                            rounded
                            class="ml-auto mr-2"
                            @click="estimate.dialog = false"
                          >
                            Close
                          </v-btn>
                          <v-btn
                            rounded
                            color="primary"
                            @click="onEstimationDialogConfirmed()"
                          >
                            Estimate
                          </v-btn>
                        </div>
                      </v-card-actions>
                    </v-card>
                  </v-dialog>
                </div>
                <v-row
                  v-for="(block, blockIndex) in uiCoordinatesBlocks"
                  :key="'block-' + blockIndex"
                >
                  <v-col
                    v-for="itemSlotIndex in block.slots"
                    :key="'block-item-slot-' + itemSlotIndex"
                    cols="auto"
                  >
                    <div class="d-flex align-baseline">
                      <div class="caption mb-2">
                        {{ itemSlotLabels[itemSlotIndex] }}
                      </div>
                      <v-btn
                        small
                        text
                        plain
                        color="grey"
                        class="my-0 ml-auto mr-0"
                        @click="moveMouseTo(editing.settings.uiCoordinates[itemSlotIndex].x, editing.settings.uiCoordinates[itemSlotIndex].y)"
                      >
                        Move Mouse
                      </v-btn>
                    </div>
                    <div class="d-flex">
                      <v-text-field
                        v-model="editing.settings.uiCoordinates[itemSlotIndex].x"
                        label="X"
                        type="number"
                        class="mr-2"
                        style="max-width: 120px"
                        hide-details
                        suffix="px"
                        solo
                      ></v-text-field>
                      <v-text-field
                        v-model="editing.settings.uiCoordinates[itemSlotIndex].y"
                        label="Y"
                        type="number"
                        style="max-width: 120px"
                        hide-details
                        suffix="px"
                        solo
                      ></v-text-field>
                    </div>
                  </v-col>
                  <v-spacer></v-spacer>
                </v-row>
                <div
                  class="d-flex white"
                  style="
                    width: 100%;
                    position: fixed;
                    bottom: 24px;
                    right: 24px;
                  "
                >
                  <div class="d-flex align-center">
                    <v-btn
                      rounded
                      style="margin-left: 64px"
                      color="secondary"
                      @click="debugUiCoordinatesWithScreenshot(editing.settings.uiCoordinates)"
                    >
                      <v-icon left>mdi-image-outline</v-icon>
                      Debug with a Screenshot
                    </v-btn>
                    <div
                      v-if="$vuetify.breakpoint.mdAndUp"
                      class="ml-3 caption info--text"
                    >
                      Please use <b>Window Mode: Borderless</b> and go to Equipment first
                    </div>
                  </div>
                  <div class="ml-auto">
                    <v-btn
                      text
                      rounded
                      color="secondary"
                      @click="cancelSettings()"
                    >
                      Cancel
                    </v-btn>
                    <v-btn
                      color="primary"
                      rounded
                      @click="saveSettings()"
                    >
                      Save Settings
                    </v-btn>
                  </div>
                </div>
              </v-col>
            </v-row>
            <!-- Main Page -->
            <v-row
              v-else-if="!loading"
              class="fill-height"
            >
              <!-- Left column -->
              <v-col
                cols="12"
                :sm="6"
                :md="5"
                :xl="4"
              >
                <v-row align="center" class="mt-3 mb-4">
                  <h2>Loadouts</h2>
                  <!-- Search -->
                  <div class="d-flex flex-nowrap">
                    <v-btn
                      v-if="!showSearch"
                      text
                      rounded
                      class="ml-3 grey--text"
                      title="Search Loadouts"
                      @click="onShowSearchButtonClicked()"
                    >
                      <v-icon left>mdi-magnify</v-icon> Search ({{ loadouts.length }})
                    </v-btn>
                    <v-text-field
                      v-if="showSearch"
                      ref="search"
                      v-model="searchText"
                      class="pt-0 ml-4"
                      hide-details
                      placeholder="Search"
                      :label="!searchText ? '' : filteredLoadouts.length + '/' + loadouts.length"
                      prepend-inner-icon="mdi-magnify"
                      clearable
                      @click:clear="resetSearch()"
                      @keydown.esc="resetSearch()"
                      @blur="searchText == '' ? resetSearch() : null"
                    ></v-text-field>
                  </div>
                  <v-spacer></v-spacer>
                  <!-- Add Loadout -->
                  <v-btn
                    v-if="!showSearch"
                    text
                    rounded
                    color="primary"
                    @click="addNewLoadout()"
                  >
                    <v-icon left>mdi-plus-thick</v-icon> Loadout
                  </v-btn>
                </v-row>
                <v-list dense>
                  <template v-for="(loadout, loadoutIndex) in filteredSortedLoadouts">
                    <v-hover v-slot="{hover}">
                      <v-list-item
                        :key="'loadout-tile-' + loadoutIndex + loadout.id"
                        title="Edit this Loadout"
                        @click="editLoadout(loadout)"
                      >
                        <!-- Toggle Favorite -->
                        <div v-if="hover || loadout.favorite">
                          <v-btn
                            small
                            icon
                            class="my-0 ml-0 mr-2"
                            :class="{'primary--text': loadout.favorite}"
                            title="Un/favorite this Loadout"
                            @click.stop="favoriteLoadout(loadout)"
                          >
                            <v-icon small>
                              {{ loadout.favorite ? 'mdi-heart' : 'mdi-heart-outline' }}
                            </v-icon>
                          </v-btn>
                        </div>
                        <v-list-item-content @dblclick="equipLoadout(loadout)">
                          <v-list-item-title
                            :class="{
                              'primary--text font-weight-bold': editing.loadout && editing.loadout.id == loadout.id,
                            }"
                          >
                            <v-icon
                              v-if="loadout.base"
                              x-small
                              color="grey"
                              title="This loadout is based on another loadout"
                            >
                              mdi-link-variant
                            </v-icon>
                            {{ loadout.label }}
                          </v-list-item-title>
                          <v-list-item-subtitle
                            :class="{'primary--text': editing.loadout && editing.loadout.id == loadout.id}"
                          >
                            {{ resolveLoadout(loadout)[1] }}<span v-if="resolveLoadout(loadout)[1]">, </span>{{ resolveLoadout(loadout)[2] }}
                          </v-list-item-subtitle>
                        </v-list-item-content>
                        <!-- Action Buttons -->
                        <div
                          v-if="hover"
                          class="d-flex"
                        >
                          <v-btn
                            icon
                            color="primary"
                            title="Equip this Loadout"
                            @click.stop="equipLoadout(loadout)"
                          >
                            <v-icon>mdi-play</v-icon>
                          </v-btn>
                          <v-btn
                            icon
                            title="Duplicate this Loadout"
                            @click.stop="duplicateLoadout(loadout)"
                          >
                            <v-icon>mdi-content-copy</v-icon>
                          </v-btn>
                          <v-btn
                            icon
                            color="error"
                            title="Delete this Loadout"
                            @click.stop="askDeleteLoadout(loadout)"
                          >
                            <v-icon>mdi-delete-outline</v-icon>
                          </v-btn>
                        </div>
                      </v-list-item>
                    </v-hover>
                    <v-divider
                      v-if="loadoutIndex < filteredSortedLoadouts.length - 1"
                      :key="'divider-' + loadoutIndex"
                    ></v-divider>
                  </template>
                </v-list>
              </v-col>
              <!-- Right column -->
              <v-col
                v-if="editing.loadout"
                cols="12"
                sm="6"
                md="7"
                xl="8"
              >
                <div
                  class="d-flex align-baseline justify-space-between mt-2 mb-2"
                >
                  <div class="title">
                    Name of Loadout
                  </div>
                  <v-btn
                    text
                    rounded
                    class="ma-0"
                    color="primary"
                    @click="equipLoadout(editing.loadout)"
                  >
                    <v-icon class="mr-2">mdi-play</v-icon> Equip this Loadout
                  </v-btn>
                </div>
                <v-row class="mb-3">
                  <v-col>
                    <!-- Label -->
                    <v-text-field
                      v-if="editing.loadout"
                      v-model="editing.loadout.label"
                      placeholder="Name of Loadout"
                      hide-details
                      clearable
                      class="pt-0 mb-2"
                      @click:clear="editing.loadout.label = ''"
                    ></v-text-field>
                  </v-col>
                </v-row>
                <!-- Base Loadout (optional) -->
                <div
                  class="subtitle-2 mt-3 mb-3"
                  :class="{'clickable': editingLoadoutCanDefineBase}"
                  title="Expand/collapse base loadout"
                  @click="editing.expandBaseLoadout = !editing.expandBaseLoadout"
                >
                  Base (optional)
                  <v-icon v-if="editingLoadoutCanDefineBase">
                    {{ editing.expandBaseLoadout ? 'mdi-chevron-up' : 'mdi-chevron-down' }}
                  </v-icon>
                  <div
                    v-else
                    class="body-2 grey--text mt-2"
                  >
                    Because this loadout is used as a base in other loadouts,
                    it can not have a base itself.
                  </div>
                </div>
                <v-slide-y-transition>
                  <v-row
                    v-if="editingLoadoutCanDefineBase && editing.expandBaseLoadout"
                    class="mb-3"
                  >
                    <v-col>
                      <v-select
                        v-model="editing.loadout.base"
                        :items="sortedLoadoutsWithoutBase.filter(loadout => loadout.id != editing.loadout.id)"
                        item-text="label"
                        item-value="id"
                        hide-details
                        solo
                        placeholder="Select a base loadout"
                        clearable
                      ></v-select>
                    </v-col>
                  </v-row>
                </v-slide-y-transition>
                <!-- Weapons -->
                <div class="subtitle-2 mt-3 mb-3">Weapons</div>
                <v-row
                  v-for="weaponIndex of [1, 2]"
                  :key="'weapon-row-' + weaponIndex"
                  dense
                >
                  <v-col>
                    <v-combobox
                      v-if="editing.loadout"
                      v-model="editing.loadout[weaponIndex]"
                      :items="getValidWeaponNamesForSlot(weaponIndex)"
                      :label="getEditingLabelItemLabel(weaponIndex)"
                      :title="tooltipItemSlot"
                      clearable
                      solo
                      hide-details
                      hide-no-data
                      auto-select-first
                      class="pt-0 mb-2"
                      :class="{
                        'muted': editing.loadout.excludes && editing.loadout.excludes[weaponIndex],
                      }"
                      :prepend-inner-icon="getLoadoutItemSlotPrependInnerIcon(weaponIndex)"
                      :prepend-icon="getLoadoutItemSlotPrependIcon(weaponIndex)"
                      @click:prepend="onToggleLoadoutItemSlotIndexClicked($event, editing.loadout, weaponIndex)"
                      @click:clear="editing.loadout[weaponIndex] = ''"
                      @keydown.esc="editing.loadout[weaponIndex] = ''"
                    ></v-combobox>
                  </v-col>
                </v-row>
                <!-- Tools -->
                <div class="subtitle-2 mt-3 mb-3">Tools</div>
                <v-row dense>
                  <v-col
                    v-for="toolsIndex of [3, 4, 5, 6]"
                    :key="'tools-col-' + toolsIndex"
                    cols="12"
                    md="6"
                    xl="3"
                  >
                    <v-combobox
                      v-if="editing.loadout"
                      v-model="editing.loadout[toolsIndex]"
                      :items="getValidToolNamesForSlot(toolsIndex)"
                      :label="getEditingLabelItemLabel(toolsIndex)"
                      :title="tooltipItemSlot"
                      clearable
                      solo
                      hide-details
                      hide-no-data
                      auto-select-first
                      class="pt-0 mb-2"
                      :class="{'muted': editing.loadout.excludes && editing.loadout.excludes[toolsIndex]}"
                      :prepend-inner-icon="getLoadoutItemSlotPrependInnerIcon(toolsIndex)"
                      :prepend-icon="getLoadoutItemSlotPrependIcon(toolsIndex)"
                      @click:prepend="onToggleLoadoutItemSlotIndexClicked($event, editing.loadout, toolsIndex)"
                      @click:clear="editing.loadout[toolsIndex] = ''"
                      @keydown.esc="editing.loadout[toolsIndex] = ''"
                      ></v-combobox>
                  </v-col>
                </v-row>
                <!-- Consumables -->
                <div class="subtitle-2 mt-3 mb-3">Consumables</div>
                <v-row dense>
                  <v-col
                    v-for="consumablesIndex of [7, 8, 9, 10]"
                    :key="'consumables-col-' + consumablesIndex"
                    cols="12"
                    md="6"
                    xl="3"
                  >
                    <v-combobox
                      v-if="editing.loadout"
                      v-model="editing.loadout[consumablesIndex]"
                      :items="getValidConsumableNamesForSlot(consumablesIndex)"
                      :label="getEditingLabelItemLabel(consumablesIndex)"
                      :title="tooltipItemSlot"
                      clearable
                      solo
                      hide-details
                      hide-no-data
                      auto-select-first
                      class="pt-0 mb-2"
                      :class="{'muted': editing.loadout.excludes && editing.loadout.excludes[consumablesIndex]}"
                      :prepend-inner-icon="getLoadoutItemSlotPrependInnerIcon(consumablesIndex)"
                      :prepend-icon="getLoadoutItemSlotPrependIcon(consumablesIndex)"
                      @click:prepend="onToggleLoadoutItemSlotIndexClicked($event, editing.loadout, consumablesIndex)"
                      @click:clear="editing.loadout[consumablesIndex] = ''"
                      @keydown.esc="editing.loadout[consumablesIndex] = ''"
                      ></v-combobox>
                  </v-col>
                </v-row>
                <v-row
                  style="
                    position: fixed;
                    bottom: 36px;
                    right: 36px;
                  "
                >
                  <div class="white">
                    <v-btn
                      text
                      rounded
                      color="secondary"
                      @click="cancelEditingLoadout()"
                    >
                      Cancel
                    </v-btn>
                    <v-btn
                      :depressed="!editingLayoutNeedsSaving"
                      :class="[editingLayoutNeedsSaving ? 'primary' : 'grey lighten-4']"
                      rounded
                      :disabled="!canSaveEditing"
                      @click="saveEditingLoadout()"
                    >
                      Save Loadout
                    </v-btn>
                  </div>
                </v-row>
              </v-col>
            </v-row>
            <!-- Feedback Snackbar -->
            <v-snackbar
              v-model="snackbar.show"
              :timeout="snackbar.timeout"
              :color="snackbar.color"
            >
              <v-icon class="mr-2">{{ snackbar.icon }}</v-icon>
              {{ snackbar.text }}

              <template v-slot:action="{ attrs }">
                <v-btn
                  color="white"
                  text
                  rounded
                  v-bind="attrs"
                  @click="snackbar.show = false"
                >
                  Close
                </v-btn>
              </template>
            </v-snackbar>
          </v-container>
        </v-main>
      </v-app>
    </div>
    <script type="text/javascript" src="/eel.js"></script>
    <script type="text/javascript" src="/vendor/vue.2.6.14.min.js"></script>
    <script type="text/javascript" src="/vendor/vuetify.2.5.8.min.js"></script>
    <script type="text/javascript" src="/vendor/lodash.4.17.21.min.js"></script>
    <script type="text/javascript" src="/js/utils.js"></script>
    <script type="text/javascript" src="/js/huntItems.js"></script>
    <script type="text/javascript" src="/js/estimator.js"></script>
    <script>

      const DEFAULT_LOADOUT = {
        1: 'Romero',
        2: 'Pax',
        3: 'Knuckle Knife',
        4: 'First Aid Kit',
        5: 'Fusees',
        6: 'Choke Bombs',
        7: 'Vitality Shot',
        8: 'Fire Bomb',
        9: 'Weak Antidote Shot',
        10: 'Flash Bomb',
        excludes: {
          // 1: true,
        },
        id: 1,
        label: "Romero + Pax",
      }

      const NEW_LOADOUT_TEMPLATE = {
        1: "",
        10: "",
        2: "",
        3: "",
        4: "",
        5: "",
        6: "",
        7: "",
        8: "",
        9: "",
        base: null,  // ID of based loadout.
        excludes: {
          // 1: true,
        },
        favorite: false,
        id: null,
        label: "A new loadout",
      };

      window.app = new Vue({
        el: "#app",
        vuetify: new Vuetify(),
        data() {
          return {
            showSearch: false,
            searchText: '',
            currentFilepath: null,
            loading: false,
            estimate: {
              dialog: false,
              width: 1920,
              height: 1080,
            },
            uiCoordinatesBlocks: [
              {'slots': [1]},
              {'slots': [2]},
              {'slots': [3, 4, 5, 6]},
              {'slots': [7, 8, 9, 10]},
              {'slots': [
                'search_box',
                'remove_filters_button',
                'first_item_in_list'
              ]},
              {'slots': [
                'discard_item_dialog_yes_button',
                'transaction_not_possible_dialog_ok_button'
              ]},
            ],
            settings: {
              uiCoordinates: deepCopy(uiCoordinatesEstimator.sampleUiCoordinates),
            },
            snackbar: {
              show: false,
              text: '',
              timeout: 1000,
              color: 'success',
            },
            editing: {
              loadout: null,
              resolvedLoadout: null,
              expandBaseLoadout: false,
              settings: null,
            },
            itemSlotLabels: {
              '1': 'Weapon 1',
              '2': 'Weapon 2',
              '3': 'Tool 1',
              '4': 'Tool 2',
              '5': 'Tool 3',
              '6': 'Tool 4',
              '7': 'Consumable 1',
              '8': 'Consumable 2',
              '9': 'Consumable 3',
              '10': 'Consumable 4',
              'search_box': 'Search equipment field',
              'remove_filters_button': 'Remove equipment filters button',
              'first_item_in_list': 'First item in equipment list',
              'discard_item_dialog_yes_button': '"Discard item" dialog yes button',
              'transaction_not_possible_dialog_ok_button': '"Transaction not possible" dialog ok button',
            },
            loadouts: [
              DEFAULT_LOADOUT,
            ],
            tooltipItemSlot: (
              'Toggle checkbox to exclude this item when equipping. ' +
              'Shift-Click to equip just this item slot.'
            )
          };
        },
        computed: {
          editingResolvedLoadout() {
            if (!this.editing.loadout) {
              return null;
            }
            return this.resolveLoadout(this.editing.loadout);
          },
          editingLoadoutCanDefineBase() {
            if (!this.editing.loadout) {
              return;
            }
            const bases = this.loadouts.map(loadout => loadout.base);
            const usedAsBase = bases.indexOf(this.editing.loadout.id) !== -1;
            return !usedAsBase;
          },
          // allUniqueLoadoutItemNames() {
          //   const uniqueItemNames = new Set();
          //   for (const loadout of this.loadouts) {
          //     for (let i = 0; i <= 10; i++) {
          //       const itemName = loadout[i];
          //       if (itemName) {
          //         uniqueItemNames.add(itemName);
          //       }
          //     }
          //   }
          //   return Array.from(uniqueItemNames).sort();
          // },
          fileData() {
            return {
              version: 1,
              loadouts: deepCopy(this.loadouts),
              settings: deepCopy(this.settings),
            };
          },
          canSaveEditing() {
            const noDuplicateLabel = (
              this.loadouts
                .filter(loadout => loadout.id !== this.editing.loadout.id)
                .filter(
                  loadout => {
                    return (
                      loadout.label.trim().toLowerCase() ===
                      this.editing.loadout.label.trim().toLowerCase()
                    )
                  }
                )
                .length == 0
            );
            const validLabel = (
              !!this.editing.loadout.label &&
              this.editing.loadout.label.trim() !== '' &&
              noDuplicateLabel
            );
            return this.editing.loadout && validLabel;
          },
          editingLayoutNeedsSaving() {
            if (!this.editing.loadout) {
              return false;
            }
            const savedLoadoutIds = this.loadouts.map(loadout => loadout.id);
            const unsaved = savedLoadoutIds.indexOf(this.editing.loadout.id) === -1;
            if (unsaved) {
              return true;
            }

            const original = this.loadouts.filter(
              loadout => loadout.id === this.editing.loadout.id
            )[0];
            return !_.isEqual(original, this.editing.loadout);
          },
          filteredLoadouts() {
            if (!this.showSearch || !this.searchText) {
              return this.loadouts;
            }

            searchText = this.searchText.toLowerCase();

            return this.loadouts.filter(loadout => {
              const loadoutTerms = [loadout.label.toLowerCase()];
              for (let i = 1; i <= 10; i++) {
                const itemName = loadout[i];
                if (itemName) {
                  loadoutTerms.push(itemName.toLowerCase());
                }
              }
              return loadoutTerms.some(term => term.indexOf(searchText) !== -1);
            });
          },
          filteredSortedLoadouts() {
            return this.filteredLoadouts.sort(this.compareLoadouts);
          },
          sortedLoadoutsWithoutBase() {
            return this.loadouts.slice().filter(loadout => !loadout.base).sort(this.compareLoadouts);
          },
        },
        mounted() {
          this.getVersion()((version) => {
            if (version) {
              document.title += ' v' + version;
            }
          });

          this.loading = true;
          eel.load_data_from_last_filepath_in_userdir()((lastFilepath) => {
            if (!!lastFilepath) {
              this.currentFilepath = lastFilepath;
            }
            // this.selectFirstLoadoutForEditing();
            this.loading = false;
          });
          this.setEstimationScreenSizeDefaults();
        },
        methods: {
          /**
           * Weapons depend on their size:
           * - Large and small
           * - Medium and small
           * - Medium and medium
           * - Small and small
           */
          getValidWeaponNamesForSlot(weaponSlotIndex) {
            const allWeaponNames = huntItems.weapons.map(
              weapon => weapon.legendary || weapon.name
            );

            // weaponSlotIndex is either 1 or 2.
            const secondaryIndex = weaponSlotIndex == 1 ? 2 : 1;
            const secondaryWeaponName = this.editing.loadout[secondaryIndex];
            if (!secondaryWeaponName) {
              return allWeaponNames;
            }

            const secondaryWeapon = huntItems.weapons.filter(
              weapon => {
                return (
                  weapon.legendary == secondaryWeaponName ||
                  weapon.name == secondaryWeaponName
                );
              }
            )[0];
            if (!secondaryWeapon) {
              return allWeaponNames;
            };

            if (secondaryWeapon.size == 'large') {
              return huntItems.weapons
                .filter(weapon => weapon.size == 'small')
                .map(weapon => weapon.legendary || weapon.name);
            }
            else if (secondaryWeapon.size == 'medium') {
              return huntItems.weapons
                .filter(weapon => ['small', 'medium'].includes(weapon.size))
                .map(weapon => weapon.legendary || weapon.name);
            }
            // Small can be combined with anything.
            return allWeaponNames;
          },
          /**
           * Can not use a tool more than once.
           */
          getValidToolNamesForSlot(toolSlotIndex) {
            const allToolNames = huntItems.tools.map(tool => tool.name);
            const toolNamesAlreadyUsed = [
              this.editing.loadout[3],
              this.editing.loadout[4],
              this.editing.loadout[5],
              this.editing.loadout[6],
            ];
            return allToolNames.filter(
              name => toolNamesAlreadyUsed.indexOf(name) === -1
            );
          },
          /**
           * Can use multiple consumables of the same type.
           */
          getValidConsumableNamesForSlot(consumableSlotIndex) {
            const allConsumableNames = huntItems.consumables.map(
              consumable => consumable.name
            );
            return allConsumableNames;
          },
          getEditingLabelItemLabel(itemSlotIndex) {
            if (this.editing.loadout && this.editing.loadout.base) {
              const item = this.editing.loadout[itemSlotIndex];
              const resolvedItem = this.editingResolvedLoadout[itemSlotIndex];
              if (resolvedItem === null && item === '') {
                return this.itemSlotLabels[itemSlotIndex];
              }
              if (resolvedItem !== item) {
                return resolvedItem;
              }
            }
            return this.itemSlotLabels[itemSlotIndex];
          },
          isItemSlotInheritedFromBaseLoadout(itemSlotIndex, loadout, resolvedLoadout) {
            const item = loadout[itemSlotIndex];
            let resolvedItem = resolvedLoadout[itemSlotIndex];
            if (resolvedItem === null && item === '') {
              // Treat excludes from base loadout and empty slots in the
              // actual loadout as 'not inheriting', since the base does
              // not define something to inherit.
              return false;
            }
            return resolvedItem !== item;
          },
          compareLoadouts(loadoutA, loadoutB) {
            const prefixA = loadoutA.favorite ? 'a_' : 'z_';
            const prefixB = loadoutB.favorite ? 'a_' : 'z_';
            if (prefixA + loadoutA.label > prefixB + loadoutB.label) return 1;
            if (prefixB + loadoutB.label > prefixA + loadoutA.label) return -1;
            return 0;
          },
          moveMouseTo(x, y) {
            eel.move_mouse_to(x, y);
          },
          migrateLoadouts(loadouts) {
            const migratedLoadouts = deepCopy(loadouts);
            for (let i = 0; i < migratedLoadouts.length; i++) {
              const loadout = migratedLoadouts[i];

              if (loadout.favorite === undefined) {
                console.log('[MIGRATE] Adding loadout.favorite', loadout);
                this.$set(loadout, 'favorite', NEW_LOADOUT_TEMPLATE.favorite);
              }

              if (loadout.base === undefined) {
                console.log('[MIGRATE] Adding loadout.base', loadout);
                this.$set(loadout, 'base', NEW_LOADOUT_TEMPLATE.base);
              }

            }
            return migratedLoadouts;
          },
          migrateSettings(settings) {
            const migratedSettings = deepCopy(settings);

            // No longer storing uiCoordinatesBlocks in settings.
            if (migratedSettings.uiCoordinatesBlocks) {
              console.log('[MIGRATE] Removing settings.uiCoordinatesBlocks');
              delete migratedSettings.uiCoordinatesBlocks
            }

            // Some UIelements have been added later.
            const uiNames = [
              'discard_item_dialog_yes_button',
              'transaction_not_possible_dialog_ok_button',
            ];
            for (const uiName of uiNames) {
              if (!migratedSettings.uiCoordinates[uiName]) {
                console.log(
                  '[MIGRATE] Adding settings.uiCoordinates.' + uiName
                );
                estimatedUiCoordinates = uiCoordinatesEstimator.estimate(
                  this.estimate.width, this.estimate.height
                );
                migratedSettings.uiCoordinates[uiName] = estimatedUiCoordinates[uiName];
              }
            }

            return migratedSettings;
          },
          onShowSearchButtonClicked() {
            this.showSearch = true;
            this.$nextTick(() => {
              this.$refs.search.focus();
            });
          },
          resetSearch() {
            this.showSearch = false;
            this.searchText = '';
          },
          getVersion() {
            return eel.get_version();
          },
          resetCurrentFilepath() {
            this.currentFilepath = null;
            eel.forget_last_filepath();
          },
          openGitHubPageInDefaultBrowser() {
            eel.open_git_hub_page_in_default_browser();
          },
          selectFirstLoadoutForEditing() {
            if (this.loadouts.length > 0) {
              this.editLoadout(this.loadouts[0]);
            }
          },
          setEstimationScreenSizeDefaults() {
            eel.get_primary_screen_size()((screenSize) => {
              const autoEstimate = (
                !this.currentFilepath &&
                this.estimate.width == 1920 &&
                this.estimate.height == 1080
              );

              this.estimate.width = screenSize[0];
              this.estimate.height = screenSize[1];

              if (autoEstimate) {
                this.editSettings();
                this.setEditingUiCoordinatesForResolution(
                  this.estimate.width, this.estimate.height
                );
                this.saveSettings();
                this.showSnackbarText(
                  'Coordinates have been auto-estimated based on your screen',
                  10000, 'info', 'mdi-information-outline'
                );
              }
            });
          },
          onEstimationDialogConfirmed() {
            if (!this.editing.settings) {
              return;
            }
            this.estimate.dialog = false;
            this.setEditingUiCoordinatesForResolution(
              this.estimate.width, this.estimate.height
            );
            this.showSnackbarText('Coordinates estimated');
          },
          setEditingUiCoordinatesForResolution(width, height) {
            const estimatedUiCoordinates = uiCoordinatesEstimator.estimate(width, height);
            this.editing.settings.uiCoordinates = deepCopy(estimatedUiCoordinates);
          },
          debugUiCoordinatesWithScreenshot(uiCoordinates) {
            eel.put_hunt_in_foreground_and_debug_ui_coordinates_in_screenshot(
              uiCoordinates
            );
          },
          editSettings() {
            this.editing.settings = deepCopy(this.settings);
            this.cancelEditingLoadout();
          },
          cancelSettings() {
            this.editing.settings = null;
          },
          saveSettings() {
            this.settings = deepCopy(this.editing.settings);
            this.editing.settings = deepCopy(this.settings);
            this.showSnackbarText('Settings saved');
          },
          toggleSettings() {
            if (this.editing.settings) {
              this.cancelSettings();
            } else {
              this.editSettings();
            }
          },
          getLoadoutItemSlotPrependInnerIcon(itemSlotIndex) {
            if (
              this.editing.loadout &&
              this.isItemSlotInheritedFromBaseLoadout(
                itemSlotIndex, this.editing.loadout, this.editingResolvedLoadout
              )
            ) {
              return 'mdi-link-variant';
            }
            return null;
          },
          getLoadoutItemSlotPrependIcon(itemSlotIndex) {
            if (
              this.editing.loadout &&
              this.editing.loadout.excludes === undefined ||
              !this.editing.loadout.excludes[itemSlotIndex]
            ) {
              return 'mdi-checkbox-marked';
            }
            return 'mdi-checkbox-blank-outline';
          },
          onToggleLoadoutItemSlotIndexClicked(event, loadout, itemSlotIndex) {
            // Holding shift key while pressing will equip the item slot.
            if (event.shiftKey) {
              this.equipLoadoutItemSlot(loadout, itemSlotIndex);
              return;
            }

            if (loadout.excludes === undefined) {
              this.$set(loadout, 'excludes', {});
            }

            // Holding alt will check/uncheck all.
            if (event.altKey) {
              const excluded = !loadout.excludes[itemSlotIndex];
              for (let i = 1; i <= 10; i++) {
                this.$set(loadout.excludes, i, excluded);
              }
            } else {
              // Check/uncheck just this slot.
              this.$set(
                loadout.excludes, itemSlotIndex, !loadout.excludes[itemSlotIndex]
              );
            }

          },
          saveToCurrentFile() {
            if (!this.currentFilepath) {
              return;
            }
            if (this.editing.settings) {
              this.saveSettings();
            }
            if (this.editing.loadout) {
              this.saveEditingLoadout();
            }
            eel.save_to_file(this.fileData, this.currentFilepath);
          },
          exportToFile() {
            eel.choose_file_and_export_to(this.fileData)(filepath => {
              this.currentFilepath = filepath;
            });;
          },
          importFromFile() {
            eel.choose_file_and_import_from()(filepath => {
              this.currentFilepath = filepath;
            });
          },
          loadFileData(data) {
            this.loadouts = this.migrateLoadouts(data.loadouts);

            if (this.editing.loadout) {
              this.cancelEditingLoadout();
            }

            if (data.settings) {
              this.settings = this.migrateSettings(data.settings);

              if (this.editing.settings) {
                this.editSettings();
              }
            }
          },
          favoriteLoadout(loadout) {
            this.$set(loadout, 'favorite', !loadout.favorite);
            this.saveLoadoutById(loadout, loadout.id);
          },
          equipLoadout(loadout) {
            this.showSnackbarText('Equipping "' + loadout.label + '"...');

            const resolvedLoadout = this.resolveLoadout(loadout);
            eel.put_hunt_in_foreground_and_equip_loadout(
              resolvedLoadout, this.settings.uiCoordinates
            );
          },
          equipLoadoutItemSlot(loadout, itemSlotIndex) {
            const resolvedLoadout = this.resolveLoadout(loadout);
            eel.put_hunt_in_foreground_and_equip_loadout_item_slot(
              resolvedLoadout, itemSlotIndex, this.settings.uiCoordinates
            );
          },
          showSnackbarText(
            text, timeout = 1000, color = 'success', icon = 'mdi-check'
          ) {
            this.snackbar.text = text;
            this.snackbar.timeout = timeout;
            this.snackbar.color = color;
            this.snackbar.icon = icon;
            this.snackbar.show = true;
          },
          getHighestId() {
            const ids = (
              this.loadouts
                .filter(loadout => loadout.id !== null)
                .map(loadout => loadout.id)
            );
            return Math.max(...ids) || 1;
          },
          getNewId() {
            return this.getHighestId() + 1;
          },
          saveLoadoutById(loadoutToSave, loadoutId) {
            for (let index = 0; index < this.loadouts.length; index++) {
              const storedLoadout = this.loadouts[index];
              if (storedLoadout.id == loadoutId) {
                this.$set(this.loadouts, index, deepCopy(loadoutToSave));
                return true;
              }
            }
            return false;
          },
          saveEditingLoadout() {
            if (!this.editing.loadout) {
              return;
            }
            const saved = this.saveLoadoutById(
              this.editing.loadout, this.editing.loadout.id
            );
            if (saved) {
              this.showSnackbarText('Loadout saved');
            }
          },
          cancelEditingLoadout() {
            this.editing.loadout = null;
          },
          labelExistsMoreThan(label, num) {
            return this.loadouts.filter(
              loadout => loadout.label.trim().toLowerCase() == label.trim().toLowerCase()
            ).length > num;
          },
          isExistingLabel(label) {
            return this.labelExistsMoreThan(label, 0);
          },
          addNewLoadout() {
            const newLoadout = deepCopy(NEW_LOADOUT_TEMPLATE);
            while (this.isExistingLabel(newLoadout.label)) {
              newLoadout.label += ' (new)';
            }
            newLoadout.id = this.getNewId();
            this.loadouts.push(newLoadout);
            this.editing.loadout = deepCopy(newLoadout);
            this.editing.expandBaseLoadout = true;
          },
          duplicateLoadout(loadout) {
            const duplicatedLoadout = deepCopy(loadout);
            while (this.isExistingLabel(duplicatedLoadout.label)) {
              duplicatedLoadout.label += ' (copy)';
            }
            duplicatedLoadout.id = this.getNewId();

            this.loadouts.push(duplicatedLoadout);
            this.editing.loadout = deepCopy(duplicatedLoadout);
          },
          editLoadout(loadout) {
            if (this.editing.loadout && this.editingLayoutNeedsSaving)  {
              const confirmed = confirm('Current loadout has been modified. Save it?');
              if (confirmed) {
                this.saveEditingLoadout();
              }
            }

            this.editing.loadout = deepCopy(loadout);
            this.editing.expandBaseLoadout = !!this.editing.loadout.base;
          },
          /**
           * Resolve optional base loadout.
           */
          resolveLoadout(loadoutToResolve) {
            if (!loadoutToResolve.base) {
              return loadoutToResolve;
            }
            const base = deepCopy(
              this.loadouts.filter(
                loadout => loadout.id == loadoutToResolve.base
              )[0] || {}
            );

            const top = deepCopy(loadoutToResolve);

            // Remove empty slots from top loadout so base shines through.
            for (let i = 1; i <= 10; i++) {
              const item = top[i];
              if (!item) {
                delete top[i];
              }
            }

            return {...base, ...top};
          },
          askDeleteLoadout(loadout) {
            const confirmed = confirm(
              'Do you really want to delete "' + loadout.label + '"?'
            )
            if (confirmed) {
              this.deleteLoadout(loadout);
            }
          },
          deleteLoadout(loadoutToDelete) {
            this.loadouts = this.loadouts.filter(
              loadout => loadout.id !== loadoutToDelete.id
            );
            if (this.editing.loadout) {
              const loadoutIds = this.loadouts.map(loadout => loadout.id);
              if (loadoutIds.indexOf(this.editing.loadout.id) === -1) {
                // Edited loadout has been deleted.
                this.cancelEditingLoadout();
              }
            }
          },
        },
      });

      function feedback(text, timeout = 1000, color = 'success', icon = 'mdi-check') {
        window.app.showSnackbarText(text, timeout, color, icon);
      }
      function loadFileData(data) {
        window.app.loadFileData(data);
      }
      eel.expose(feedback);
      eel.expose(loadFileData);
    </script>
    <style>
      [dbg],
      [dbg--deep],
      [dbg--deep] *,
      .dbg,
      .dbg--deep,
      .dbg--deep * {
        outline: 1px solid red !important;
      }

      [v-cloak] {
        display: none;
      }

      .clickable {
        cursor: pointer;
      }

      .muted {
        opacity: 0.5;
      }

      .number-input {
        max-width: 140px;
      }
    </style>
  </body>
</html>
