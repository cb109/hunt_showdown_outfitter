<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Hunt: Showdown - Outfitter</title>
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@mdi/font@5.x/css/materialdesignicons.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/vuetify@2.5.8/dist/vuetify.min.css"
      rel="stylesheet"
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui"
    />
  </head>
  <body>
    <div id="app">
      <v-app>
        <v-main>
          <v-container class="fill-height">
            <!-- Header -->
            <v-row
              justify="center"
              align="center"
              class="mt-4 pb-2"
            >
              <div>
                <h1>Hunt: Showdown Outfitter</h1>
                <div class="warning--text caption">
                  <b>Be warned</b>: This program automates keyboard/mouse
                  input, which can get you banned by the anti-cheat system.
                </div>
                <div class="info--text caption">
                  Please use <b>Window Mode: Fullscreen</b> for best
                  results and equip from the <b>Roster > Overview</b>
                  screen only.
                </div>
              </div>
              <v-spacer></v-spacer>
              <v-btn
                text
                :class="{'primary': editing.settings !== null}"
                @click="toggleSettings()"
              >
                <v-icon left>mdi-cog</v-icon> Settings
              </v-btn>
              <v-btn text @click="exportToFile()">
                <v-icon left>mdi-file-export-outline</v-icon> Export
              </v-btn>
              <v-btn text @click="importFromFile()">
                <v-icon left>mdi-file-import-outline</v-icon> Import
              </v-btn>
            </v-row>
            <!-- Settings Overlay Page -->
            <v-row
              v-if="editing.settings"
              class="fill-height"
            >
              <v-col>
                <h2 class="mt-3">Settings</h2>
                <p>
                  In order to automate the inventory we need to know where the item
                  slots and some buttons are (X and Y coordinates in pixels, depending on your
                  screen resolution).
                </p>
                <h3 class="title mb-3">UI Element Coordinates</h3>
                <v-row
                  v-for="block in editing.settings.uiCoordinatesBlocks"
                  :key="'block-' + idx"
                >
                  <v-col
                    v-for="itemSlotIndex in block.slots"
                    :key="'block-item-slot-' + idx"
                    cols="12"
                    sm="6"
                    md="3"
                    lg="auto"
                  >
                    <div class="caption mb-2">
                      {{ itemSlotLabels[itemSlotIndex] }}
                    </div>
                    <div class="d-flex">
                      <v-text-field
                        v-model="editing.settings.uiCoordinates[itemSlotIndex].x"
                        label="X"
                        type="number"
                        class="coords-input mr-3"
                        hide-details
                        outlined
                        suffix="px"
                        ></v-text-field>
                      <v-text-field
                        v-model="editing.settings.uiCoordinates[itemSlotIndex].y"
                        label="Y"
                        type="number"
                        class="coords-input"
                        hide-details
                        outlined
                        suffix="px"
                        ></v-text-field>
                    </div>
                  </v-col>
                  <v-spacer></v-spacer>
                </v-row>
                <div
                  class="d-flex white"
                  style="
                    width: 100%;
                    position: fixed;
                    bottom: 24px;
                    right: 24px;
                  "
                >
                  <v-row align="center">
                    <v-btn
                      style="margin-left: 64px"
                      color="secondary"
                      @click="debugUiCoordinatesWithScreenshot(editing.settings.uiCoordinates)"
                    >
                      <v-icon left>mdi-image-outline</v-icon>
                      Debug with a Screenshot
                    </v-btn>
                    <div class="ml-3 caption info--text">
                      Please use <b>Window Mode: Borderless</b> and go to Equipment first
                    </div>
                  </v-row>
                  <div class="ml-auto">
                    <v-btn text color="secondary" @click="cancelSettings()">Cancel</v-btn>
                    <v-btn
                      color="primary"
                      @click="saveSettings()"
                    >
                      Save Settings
                    </v-btn>
                  </div>
                </div>
              </v-col>
            </v-row>
            <!-- Main Page -->
            <v-row
              v-else
              class="fill-height"
            >
              <!-- Left column -->
              <v-col
                cols="12"
                sm="6"
                md="5"
                xl="4"
              >
                <v-row align="center" class="mt-3 mb-4">
                  <h2>Loadouts</h2>
                  <v-spacer></v-spacer>
                  <v-btn text color="primary" @click="addNewLoadout()">
                    <v-icon left>mdi-plus-thick</v-icon> Loadout
                  </v-btn>
                </v-row>
                <v-list>
                  <template v-for="(loadout, loadoutIndex) in sortedLoadouts">
                    <v-list-item
                      :key="'loadout-' + loadoutIndex"
                      title="Edit this Loadout"
                      :class="{'primary--text': editing.loadout && editing.loadout.id == loadout.id}"
                      @click="modifyLoadout(loadout)"
                    >
                      <div class="d-flex">
                        <v-btn
                          icon
                          color="primary"
                          class="mr-3"
                          title="Equip this Loadout"
                          @click.stop="equipLoadout(loadout)"
                        >
                          <v-icon>mdi-play</v-icon>
                        </v-btn>
                      </div>
                      <v-list-item-title>
                        {{ loadout.label }}
                      </v-list-item-title>
                      <div class="d-flex">
                        <v-btn
                          icon
                          title="Duplicate this Loadout"
                          @click.stop="duplicateLoadout(loadout)"
                        >
                          <v-icon>mdi-content-copy</v-icon>
                        </v-btn>
                        <v-btn
                          icon
                          color="error"
                          title="Delete this Loadout"
                          @click.stop="askDeleteLoadout(loadout)"
                        >
                          <v-icon>mdi-delete-outline</v-icon>
                        </v-btn>
                      </div>
                    </v-list-item>
                    <v-divider
                      v-if="loadoutIndex < loadouts.length - 1"
                      :key="'divider-' + loadoutIndex"
                    ></v-divider>
                  </template>
                </v-list>
              </v-col>
              <!-- Right column -->
              <v-col
                v-if="editing.loadout"
                cols="12"
                sm="6"
                md="7"
                xl="8"
              >
                <div class="title mt-3 mb-3">Name of Loadout</div>
                <v-row class="mb-5">
                  <v-col>
                    <!-- Label -->
                    <v-text-field
                      v-if="editing.loadout"
                      v-model="editing.loadout.label"
                      placeholder="Name of Loadout"
                      hide-details
                      clearable
                      class="pt-0 mb-2"
                      @click:clear="editing.loadout.label = ''"
                    />
                  </v-col>
                </v-row>
                <!-- Weapons -->
                <div class="title mt-3 mb-3">Weapons</div>
                <v-row dense>
                  <v-col>
                    <v-text-field
                      v-if="editing.loadout"
                      v-model="editing.loadout[1]"
                      :label="itemSlotLabels[1]"
                      hide-details
                      clearable
                      outlined
                      :title="tooltipItemSlot"
                      :prepend-icon="getLoadoutItemSlotPrependIcon(editing.loadout, 1)"
                      @click:prepend="onToggleLoadoutItemSlotIndexClicked($event, editing.loadout, 1)"
                      class="pt-0 mb-2"
                      :class="{'muted': editing.loadout.excludes && editing.loadout.excludes[1]}"
                    />
                  </v-col>
                </v-row>
                <v-row dense>
                  <v-col>
                    <v-text-field
                      v-if="editing.loadout"
                      v-model="editing.loadout[2]"
                      :label="itemSlotLabels[2]"
                      hide-details
                      clearable
                      outlined
                      :title="tooltipItemSlot"
                      :prepend-icon="getLoadoutItemSlotPrependIcon(editing.loadout, 2)"
                      @click:prepend="onToggleLoadoutItemSlotIndexClicked($event, editing.loadout, 2)"
                      class="pt-0 mb-2"
                      :class="{'muted': editing.loadout.excludes && editing.loadout.excludes[2]}"
                    />
                  </v-col>
                </v-row>
                <!-- Tools -->
                <div class="title mt-3 mb-3">Tools</div>
                <v-row dense>
                  <v-col cols="12" md="6" lg="3">
                    <v-text-field
                      v-if="editing.loadout"
                      v-model="editing.loadout[3]"
                      :label="itemSlotLabels[3]"
                      hide-details
                      clearable
                      outlined
                      :title="tooltipItemSlot"
                      :prepend-icon="getLoadoutItemSlotPrependIcon(editing.loadout, 3)"
                      @click:prepend="onToggleLoadoutItemSlotIndexClicked($event, editing.loadout, 3)"
                      class="pt-0 mb-2"
                      :class="{'muted': editing.loadout.excludes && editing.loadout.excludes[3]}"
                    />
                  </v-col>
                  <v-col cols="12" md="6" lg="3">
                    <v-text-field
                      v-if="editing.loadout"
                      v-model="editing.loadout[4]"
                      :label="itemSlotLabels[4]"
                      hide-details
                      clearable
                      outlined
                      :title="tooltipItemSlot"
                      :prepend-icon="getLoadoutItemSlotPrependIcon(editing.loadout, 4)"
                      @click:prepend="onToggleLoadoutItemSlotIndexClicked($event, editing.loadout, 4)"
                      class="pt-0 mb-2"
                      :class="{'muted': editing.loadout.excludes && editing.loadout.excludes[4]}"
                    />
                  </v-col>
                  <v-col cols="12" md="6" lg="3">
                    <v-text-field
                      v-if="editing.loadout"
                      v-model="editing.loadout[5]"
                      :label="itemSlotLabels[5]"
                      hide-details
                      clearable
                      outlined
                      :title="tooltipItemSlot"
                      :prepend-icon="getLoadoutItemSlotPrependIcon(editing.loadout, 5)"
                      @click:prepend="onToggleLoadoutItemSlotIndexClicked($event, editing.loadout, 5)"
                      class="pt-0 mb-2"
                      :class="{'muted': editing.loadout.excludes && editing.loadout.excludes[5]}"
                    />
                  </v-col>
                  <v-col cols="12" md="6" lg="3">
                    <v-text-field
                      v-if="editing.loadout"
                      v-model="editing.loadout[6]"
                      :label="itemSlotLabels[6]"
                      hide-details
                      clearable
                      outlined
                      :title="tooltipItemSlot"
                      :prepend-icon="getLoadoutItemSlotPrependIcon(editing.loadout, 6)"
                      @click:prepend="onToggleLoadoutItemSlotIndexClicked($event, editing.loadout, 6)"
                      class="pt-0 mb-2"
                      :class="{'muted': editing.loadout.excludes && editing.loadout.excludes[6]}"
                    />
                  </v-col>
                </v-row>
                <!-- Consumables -->
                <div class="title mt-3 mb-3">Consumables</div>
                <v-row dense>
                  <v-col cols="12" md="6" lg="3">
                    <v-text-field
                      v-if="editing.loadout"
                      v-model="editing.loadout[7]"
                      :label="itemSlotLabels[7]"
                      hide-details
                      clearable
                      outlined
                      :title="tooltipItemSlot"
                      :prepend-icon="getLoadoutItemSlotPrependIcon(editing.loadout, 7)"
                      @click:prepend="onToggleLoadoutItemSlotIndexClicked($event, editing.loadout, 7)"
                      class="pt-0 mb-2"
                      :class="{'muted': editing.loadout.excludes && editing.loadout.excludes[7]}"
                    />
                  </v-col>
                  <v-col cols="12" md="6" lg="3">
                    <v-text-field
                      v-if="editing.loadout"
                      v-model="editing.loadout[8]"
                      :label="itemSlotLabels[8]"
                      hide-details
                      clearable
                      outlined
                      :title="tooltipItemSlot"
                      :prepend-icon="getLoadoutItemSlotPrependIcon(editing.loadout, 8)"
                      @click:prepend="onToggleLoadoutItemSlotIndexClicked($event, editing.loadout, 8)"
                      class="pt-0 mb-2"
                      :class="{'muted': editing.loadout.excludes && editing.loadout.excludes[8]}"
                    />
                  </v-col>
                  <v-col cols="12" md="6" lg="3">
                    <v-text-field
                      v-if="editing.loadout"
                      v-model="editing.loadout[9]"
                      :label="itemSlotLabels[9]"
                      hide-details
                      clearable
                      outlined
                      :title="tooltipItemSlot"
                      :prepend-icon="getLoadoutItemSlotPrependIcon(editing.loadout, 9)"
                      @click:prepend="onToggleLoadoutItemSlotIndexClicked($event, editing.loadout, 9)"
                      class="pt-0 mb-2"
                      :class="{'muted': editing.loadout.excludes && editing.loadout.excludes[9]}"
                    />
                  </v-col>
                  <v-col cols="12" md="6" lg="3">
                    <v-text-field
                      v-if="editing.loadout"
                      v-model="editing.loadout[10]"
                      :label="itemSlotLabels[10]"
                      hide-details
                      clearable
                      outlined
                      :title="tooltipItemSlot"
                      :prepend-icon="getLoadoutItemSlotPrependIcon(editing.loadout, 10)"
                      @click:prepend="onToggleLoadoutItemSlotIndexClicked($event, editing.loadout, 10)"
                      class="pt-0 mb-2"
                      :class="{'muted': editing.loadout.excludes && editing.loadout.excludes[10]}"
                    />
                  </v-col>
                  <div class="mt-5">
                    <v-btn text color="primary" @click="equipLoadout(editing.loadout)">
                      <v-icon class="mr-2">mdi-play</v-icon> Equip this Loadout
                    </v-btn>
                  </div>
                </v-row>
                <v-row
                  style="
                    position: fixed;
                    bottom: 36px;
                    right: 36px;
                  "
                >
                  <div>
                    <v-btn text color="secondary" @click="cancelEditing()">Cancel</v-btn>
                    <v-btn
                      color="primary"
                      :disabled="!canSaveEditing"
                      @click="saveEditing()"
                    >
                      Save Loadout
                    </v-btn>
                  </div>
                </v-row>
              </v-col>
            </v-row>
            <!-- Feedback Snackbar -->
            <v-snackbar
              v-model="snackbar.show"
              :timeout="snackbar.timeout"
              :color="snackbar.color"
            >
              <v-icon class="mr-2">{{ snackbar.icon }}</v-icon>
              {{ snackbar.text }}

              <template v-slot:action="{ attrs }">
                <v-btn
                  color="white"
                  text
                  v-bind="attrs"
                  @click="snackbar.show = false"
                >
                  Close
                </v-btn>
              </template>
            </v-snackbar>
          </v-container>
        </v-main>
      </v-app>
    </div>
    <script type="text/javascript" src="/eel.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.5.8/dist/vuetify.min.js"></script>
    <script>
      function deepCopy(obj) {
        return JSON.parse(JSON.stringify(obj));
      }

      DEFAULT_LOADOUT = {
        1: 'Romero',
        2: 'Pax',
        3: 'Knuckle Knife',
        4: 'First Aid Kit',
        5: 'Fusees',
        6: 'Choke Bombs',
        7: 'Vitality Shot',
        8: 'Fire Bomb',
        9: 'Weak Antidote Shot',
        10: 'Flash Bomb',
        excludes: {
          // 1: true,
        },
        id: null,
        label: "Romero + Pax",
      }

      const NEW_LOADOUT_TEMPLATE = {
        1: "",
        10: "",
        2: "",
        3: "",
        4: "",
        5: "",
        6: "",
        7: "",
        8: "",
        9: "",
        excludes: {
          // 1: true,
        },
        id: null,
        label: "A new loadout",
      };

      window.app = new Vue({
        el: "#app",
        vuetify: new Vuetify(),
        data() {
          return {
            settings: {
              uiCoordinatesBlocks: [
                {'slots': [1]},
                {'slots': [2]},
                {'slots': [3, 4, 5, 6]},
                {'slots': [7, 8, 9, 10]},
                {'slots': ['search_box', 'remove_filters_button', 'first_item_in_list']},
              ],
              uiCoordinates: {
                // These defaults match a screen resolution of 2560 x 1080 px.
                '1': {'x': '1810', 'y': '305'},
                '2': {'x': '1810', 'y': '455'},
                '3': {'x': '1810', 'y': '600'},
                '4': {'x': '1900', 'y': '600'},
                '5': {'x': '1990', 'y': '600'},
                '6': {'x': '2085', 'y': '600'},
                '7': {'x': '1810', 'y': '750'},
                '8': {'x': '1900', 'y': '750'},
                '9': {'x': '1990', 'y': '750'},
                '10': {'x': '2085', 'y': '750'},
                'search_box': {'x': '870', 'y': '230'},
                'first_item_in_list': {'x': '950', 'y': '310'},
                'remove_filters_button': {'x': '1660', 'y': '225'},
              },
            },
            snackbar: {
              show: false,
              text: '',
              timeout: 1000,
              color: 'success',
            },
            editing: {
              loadout: null,
              settings: null,
            },
            itemSlotLabels: {
              '1': 'Weapon 1',
              '2': 'Weapon 2',
              '3': 'Tool 1',
              '4': 'Tool 2',
              '5': 'Tool 3',
              '6': 'Tool 4',
              '7': 'Consumable 1',
              '8': 'Consumable 2',
              '9': 'Consumable 3',
              '10': 'Consumable 4',
              'search_box': 'Search box',
              'remove_filters_button': 'Remove filters button',
              'first_item_in_list': 'First item in list',
            },
            loadouts: [
              DEFAULT_LOADOUT,
            ],
            tooltipItemSlot: (
              'Toggle checkbox to exclude this item when equipping. ' +
              'Shift-Click to equip just this item slot.'
            )
          };
        },
        computed: {
          fileData() {
            const migratedLoadouts = this.loadouts.slice();

            // Add .excludes attribute if needed.
            for (let i = 0; i < migratedLoadouts.length; i++) {
              if (migratedLoadouts[i].excludes === undefined) {
                migratedLoadouts[i].excludes = {};
              }
            }

            return {
              version: 1,
              loadouts: migratedLoadouts,
              settings: this.settings,
            };
          },
          canSaveEditing() {
            const noDuplicateLabel = (
              this.loadouts
                .filter(loadout => loadout.id !== this.editing.loadout.id)
                .filter(
                  loadout => {
                    return (
                      loadout.label.trim().toLowerCase() ===
                      this.editing.loadout.label.trim().toLowerCase()
                    )
                  }
                )
                .length == 0
            );
            const validLabel = (
              !!this.editing.loadout.label &&
              this.editing.loadout.label.trim() !== '' &&
              noDuplicateLabel
            );
            return this.editing.loadout && validLabel;
          },
          sortedLoadouts() {
            function compareByLabel(a, b) {
              if (a.label > b.label) return 1;
              if (b.label > a.label) return -1;
              return 0;
            }
            return this.loadouts.sort(compareByLabel);
          },
        },
        mounted() {
          eel.load_data_from_last_filepath_in_userdir();
        },
        methods: {
          debugUiCoordinatesWithScreenshot(uiCoordinates) {
            eel.put_hunt_in_foreground_and_debug_ui_coordinates_in_screenshot(
              uiCoordinates
            );
          },
          editSettings() {
            this.editing.settings = deepCopy(this.settings);
          },
          cancelSettings() {
            this.editing.settings = null;
          },
          saveSettings() {
            this.settings = deepCopy(this.editing.settings);
            this.editing.settings = deepCopy(this.settings);
            this.showSnackbarText('Settings saved');
          },
          toggleSettings() {
            if (this.editing.settings) {
              this.cancelSettings();
            } else {
              this.editSettings();
            }
          },
          getLoadoutItemSlotPrependIcon(loadout, itemSlotIndex) {
            if (loadout.excludes === undefined || !loadout.excludes[itemSlotIndex]) {
              return 'mdi-checkbox-marked';
            }
            return 'mdi-checkbox-blank-outline';
          },
          onToggleLoadoutItemSlotIndexClicked(event, loadout, itemSlotIndex) {
            // Holding shift key while pressing will equip the item slot.
            if (event.shiftKey) {
              this.equipLoadoutItemSlot(loadout, itemSlotIndex);
              return;
            }

            if (loadout.excludes === undefined) {
              this.$set(loadout, 'excludes', {});
            }
            this.$set(
              loadout.excludes, itemSlotIndex, !loadout.excludes[itemSlotIndex]
            );
          },
          exportToFile() {
            eel.choose_file_and_export_to(this.fileData);
          },
          importFromFile() {
            eel.choose_file_and_import_from();
          },
          loadFileData(data) {
            this.loadouts = data.loadouts;
            if (data.settings) {
              this.settings = data.settings;
            }
          },
          equipLoadout(loadout) {
            this.showSnackbarText('Equipping "' + loadout.label + '"...');
            eel.put_hunt_in_foreground_and_equip_loadout(
              loadout, this.settings.uiCoordinates
            );
          },
          equipLoadoutItemSlot(loadout, itemSlotIndex) {
            eel.put_hunt_in_foreground_and_equip_loadout_item_slot(
              loadout, itemSlotIndex, this.settings.uiCoordinates
            );
          },
          showSnackbarText(
            text, timeout = 1000, color = 'success', icon = 'mdi-check'
          ) {
            this.snackbar.text = text;
            this.snackbar.timeout = timeout;
            this.snackbar.color = color;
            this.snackbar.icon = icon;
            this.snackbar.show = true;
          },
          getHighestId() {
            const ids = (
              this.loadouts
                .filter(loadout => loadout.id !== null)
                .map(loadout => loadout.id)
            );
            return Math.max(...ids) || 1;
          },
          getNewId() {
            return this.getHighestId() + 1;
          },
          saveEditing() {
            if (!this.editing.loadout) {
              return;
            }
            for (let index = 0; index < this.loadouts.length; index++) {
              const loadout = this.loadouts[index];
              if (loadout.id == this.editing.loadout.id) {
                this.loadouts[index] = deepCopy(this.editing.loadout);
                this.showSnackbarText('Loadout saved');
                return;
              }
            }
          },
          cancelEditing() {
            this.editing.loadout = null;
          },
          labelExistsMoreThan(label, num) {
            return this.loadouts.filter(
              loadout => loadout.label.trim().toLowerCase() == label.trim().toLowerCase()
            ).length > num;
          },
          isExistingLabel(label) {
            return this.labelExistsMoreThan(label, 0);
          },
          addNewLoadout() {
            const newLoadout = deepCopy(NEW_LOADOUT_TEMPLATE);
            while (this.isExistingLabel(newLoadout.label)) {
              newLoadout.label += ' (new)';
            }
            newLoadout.id = this.getNewId();
            this.loadouts.push(newLoadout);
            this.editing.loadout = deepCopy(newLoadout);
          },
          duplicateLoadout(loadout) {
            const duplicatedLoadout = deepCopy(loadout);
            while (this.isExistingLabel(duplicatedLoadout.label)) {
              duplicatedLoadout.label += ' (copy)';
            }
            duplicatedLoadout.id = this.getNewId();

            this.loadouts.push(duplicatedLoadout);
            this.editing.loadout = deepCopy(duplicatedLoadout);
          },
          modifyLoadout(loadout) {
            this.editing.loadout = deepCopy(loadout);
          },
          askDeleteLoadout(loadout) {
            const confirmed = confirm(
              'Do you really want to delete "' + loadout.label + '"?'
            )
            if (confirmed) {
              this.deleteLoadout(loadout);
            }
          },
          deleteLoadout(loadoutToDelete) {
            this.loadouts = this.loadouts.filter(
              loadout => loadout.id !== loadoutToDelete.id
            );
            if (this.editing.loadout) {
              const loadoutIds = this.loadouts.map(loadout => loadout.id);
              if (loadoutIds.indexOf(this.editing.loadout.id) === -1) {
                // Edited loadout has been deleted.
                this.cancelEditing();
              }
            }
          },
        },
      });

      function feedback(text, timeout = 1000, color = 'success', icon = 'mdi-check') {
        window.app.showSnackbarText(text, timeout, color, icon);
      }
      function loadFileData(data) {
        window.app.loadFileData(data);
      }
      eel.expose(feedback);
      eel.expose(loadFileData);
    </script>
    <style>
      [dbg],
      [dbg--deep],
      [dbg--deep] *,
      .dbg,
      .dbg--deep,
      .dbg--deep * {
        outline: 1px solid red !important;
      }

      .clickable {
        cursor: pointer;
      }

      .muted {
        opacity: 0.5;
      }

      .coords-input {
        max-width: 140px;
      }
    </style>
  </body>
</html>
